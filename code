# -*- coding: utf-8 -*-

import requests
from pyxll import xl_func

@xl_func("str Tracking, int Status, int Country: int")            
def status_update(tracking, status, country):
    link = 'https://nolp.dhl.de/nextt-online-public/set_identcodes.do?lang=de&idc='
    
    if country == 1:
    
        if status >= 0 and status <=4:
            link = link + str(tracking)
        
            response = requests.get(link)
            response = str(response.content)
        
            status_list = print_all_links(response)
            
            if len(status_list) == 5:
                date = delivery_date(response)
                return len(status_list), date
            
            return len(status_list), None
        
        else:
            return None 
            
    else:
        if status >= 0 and status <=9:
            link = link + str(tracking)
        
            response = requests.get(link)
            response = str(response.content)
        
            status_list = print_all_links(response)
            
            if len(status_list) == 10:
                date = delivery_date(response)
                return len(status_list), date
                
            return len(status_list), None
        
        else:
            return None

def get_next_target(page):
    start_link = page.find('data-label="Status"')
    if start_link == -1:
        return None, 0
        
    start_quote = page.find('Die', start_link)
    end_quote = page.find('\n', start_quote)
    url = page[start_quote:end_quote]
    return url, end_quote
    
def print_all_links(page):
    targets = []
    while True:
        url, endpos = get_next_target(page)
        if url:
            targets.append(url)
            page = page[endpos:]
        else:
            return targets
            break
            
def delivery_date(page):
    start_link = page.find('Die Sendung wurde in das Zustellfahrzeug geladen')
    if start_link == -1:
        return None
        
    start_quote = page.find(',', start_link)
    date = page[start_quote + 2:start_quote + 12]
    return date
    

    
